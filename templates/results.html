<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generation Complete</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container results-container">
        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'summary')">Results Summary</button>
            <button class="tab-link" onclick="openTab(event, 'docs')">References & Docs</button>
        </div>

        <div id="summary" class="tab-content active">
            <h1>Generation Complete! ✅</h1>
            <p>Your synthetic dataset and performance analysis are ready.</p>
            
            <div class="summary-grid">
                <div class="summary-card">
                    <h2>Pipeline Summary</h2>
                    <ul class="pipeline-list">
                        {% for title, description in pipeline_stages %}
                            <li><div class="pipeline-icon">✓</div><div class="pipeline-text"><span class="pipeline-title">{{ title }}</span><span class="pipeline-description">{{ description }}</span></div></li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="summary-card">
                    <h2>Run Overview</h2>
                    <table class="summary-table">
                        {% for key, value in input_options.items() %}<tr><td>{{ key }}</td><td>{{ value }}</td></tr>{% endfor %}
                    </table>
                </div>
            </div>

            <h2 class="section-header">Statistical & Privacy Metric Comparison</h2>
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Initial Metrics <span class="epoch-label">(Pseudo-Real Data)</span></h3>
                    <table class="summary-table">
                        <tr><td>Pairwise Correlation Difference</td><td><span class="metric-value">{{ initial_metrics['PCD'] }}</span></td></tr>
                        <tr><td>Distance to Closest Record</td><td><span class="metric-value">{{ initial_metrics['DCR'] }}</span></td></tr>
                        <tr><td>Nearest Neighbor Distance Ratio</td><td><span class="metric-value">{{ initial_metrics['NNDR'] }}</span></td></tr>
                    </table>
                </div>
                <div class="summary-card">
                    <h3>Final Metrics <span class="epoch-label">(Final Synthetic Data)</span></h3>
                    <table class="summary-table">
                        <tr><td>Pairwise Correlation Difference</td><td><span class="metric-value final">{{ final_metrics['PCD'] }}</span></td></tr>
                        <tr><td>Distance to Closest Record</td><td><span class="metric-value final">{{ final_metrics['DCR'] }}</span></td></tr>
                        <tr><td>Nearest Neighbor Distance Ratio</td><td><span class="metric-value final">{{ final_metrics['NNDR'] }}</span></td></tr>
                    </table>
                </div>
            </div>

            {% if pca_plot_data %}
            <h2 class="section-header">PCA: Real vs. Synthetic Data</h2>
            <div class="summary-card full-width">
                <div class="chart-card-single">
                    <canvas id="pca-chart"></canvas>
                </div>
            </div>
            {% endif %}

            {% if initial_ml_utility_scores or final_ml_utility_scores %}
            <h2 class="section-header">Machine Learning Utility Comparison</h2>
            <div class="summary-card full-width">
                <table class="ml-utility-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            {% if task_type != 'unsupervised' %}<th>Scenario</th>{% endif %}
                            <th>Initial (Pseudo-Real)</th>
                            <th>Final (Synthetic)</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% if task_type == 'classification' %}
                        {% set metrics = [('Accuracy', 0), ('F1-score', 1), ('AUC', 2)] %}
                        {% for metric_name, idx in metrics %}
                            {% for mode in ['TSTR', 'TRTS', 'TRTR', 'TSTS'] %}
                            <tr>
                                {% if loop.first %}<td rowspan="4">{{ metric_name }}</td>{% endif %}
                                <td>{{ mode }}</td>
                                <td>{{ '%.2f%%' % (initial_ml_utility_scores[mode][idx] * 100) if initial_ml_utility_scores[mode] and initial_ml_utility_scores[mode][idx] is not none and not initial_ml_utility_scores[mode][idx] | string == 'nan' else 'N/A' }}</td>
                                <td>{{ '%.2f%%' % (final_ml_utility_scores[mode][idx] * 100) if final_ml_utility_scores[mode] and final_ml_utility_scores[mode][idx] is not none and not final_ml_utility_scores[mode][idx] | string == 'nan' else 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        {% endfor %}
                    {% elif task_type == 'regression' %}
                        {% set metrics = [('R² Score', 0), ('RMSE', 1), ('MAE', 2)] %}
                         {% for metric_name, idx in metrics %}
                            {% for mode in ['TSTR', 'TRTS', 'TRTR', 'TSTS'] %}
                            <tr>
                                {% if loop.first %}<td rowspan="4">{{ metric_name }}</td>{% endif %}
                                <td>{{ mode }}</td>
                                <td>{{ '%.4f' % initial_ml_utility_scores[mode][idx] if initial_ml_utility_scores[mode] and initial_ml_utility_scores[mode][idx] is not none and not initial_ml_utility_scores[mode][idx] | string == 'nan' else 'N/A' }}</td>
                                <td>{{ '%.4f' % final_ml_utility_scores[mode][idx] if final_ml_utility_scores[mode] and final_ml_utility_scores[mode][idx] is not none and not final_ml_utility_scores[mode][idx] | string == 'nan' else 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        {% endfor %}
                    {% elif task_type == 'unsupervised' %}
                        {% for key, value in initial_ml_utility_scores.items() %}
                        <tr>
                            <td colspan="2">{{ key }}</td>
                            <td>{{ '%.4f' % value if value is not none and not value | string == 'nan' else 'N/A' }}</td>
                            <td>{{ '%.4f' % final_ml_utility_scores[key] if final_ml_utility_scores[key] is not none and not final_ml_utility_scores[key] | string == 'nan' else 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                    </tbody>
                </table>
            </div>
            {% endif %}

            <h2 class="section-header plots-header">Training Metrics Over Time</h2>
            <div class="chart-grid" id="training-chart-grid">
                <!-- Training charts will be dynamically inserted here -->
            </div>

            <a href="{{ url_for('download_file', filename=generated_filename) }}" class="btn download-btn">Download Synthetic Data (.csv)</a>
            <br>
            <a href="{{ url_for('index') }}" class="link-back">Generate another dataset</a>
        </div>

        <div id="docs" class="tab-content">
            <h1>References & Docs</h1>
            <div class="summary-card full-width explanations">
                <h3>Metric Explanations</h3>
                <p><strong>PCD (Pairwise Correlation Difference):</strong> Measures the difference between the correlation matrices of the real and synthetic data. A lower value is better, indicating higher statistical similarity. <br><em>Formula: ||corr(X_real) - corr(X_synth)||_F</em></p>
                <p><strong>DCR (Distance to Closest Record):</strong> The average Euclidean distance from each synthetic record to its nearest real record. Higher values suggest better privacy. <br><em>Formula: mean(||s_i - 1NN(s_i, R)||) for each synthetic record s_i in S</em></p>
                <p><strong>NNDR (Nearest Neighbor Distance Ratio):</strong> The ratio of the distance to the closest real record over the distance to the second closest. Values closer to 1 indicate better privacy. <br><em>Formula: mean(||s_i - 1NN|| / ||s_i - 2NN||)</em></p>
            </div>
        </div>
    </div>

    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        document.addEventListener('DOMContentLoaded', function() {
            // --- Training Plots ---
            const trainingLogs = {{ training_logs | tojson }};
            if (trainingLogs && trainingLogs.length > 0) {
                const epochs = trainingLogs.map(log => `Epoch ${log.epoch}`);
                const chartMetrics = {
                    'Overall Loss': { color: '#57A0D3', data: [] },
                    'Reconstruction Loss': { color: '#588157', data: [] },
                    'Sinkhorn Loss': { color: '#FF6384', data: [] },
                    'PCD': { color: '#F59E0B', data: [] },
                    'NNDR': { color: '#E56B6F', data: [] },
                    'DCR': { color: '#00C49F', data: [] }
                };
                trainingLogs.forEach(log => {
                    for (const key in chartMetrics) {
                        if (log[key] !== undefined && log[key] !== null) {
                            chartMetrics[key].data.push(log[key]);
                        }
                    }
                });
                const chartGrid = document.getElementById('training-chart-grid');
                for (const [metricName, properties] of Object.entries(chartMetrics)) {
                    if (properties.data.length > 0) {
                        const chartCard = document.createElement('div');
                        chartCard.className = 'chart-card';
                        const canvas = document.createElement('canvas');
                        chartCard.innerHTML = `<h2>${metricName}</h2>`;
                        chartCard.appendChild(canvas);
                        chartGrid.appendChild(chartCard);
                        new Chart(canvas.getContext('2d'), {
                            type: 'line', 
                            data: { labels: epochs, datasets: [{ label: metricName, data: properties.data, borderColor: properties.color, backgroundColor: `${properties.color}33`, fill: true, tension: 0.3, pointRadius: 0 }] },
                            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false }, x: {} }, plugins: { legend: { display: false } } }
                        });
                    }
                }
            }

            // --- PCA Plot ---
            const pcaData = {{ pca_plot_data | tojson }};
            if (pcaData) {
                const ctx = document.getElementById('pca-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [
                            { label: 'Real Data', data: pcaData.real, backgroundColor: '#57A0D399' },
                            { label: 'Synthetic Data', data: pcaData.synth, backgroundColor: '#E56B6F99' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: '2D PCA of Real vs. Synthetic Data' },
                            legend: { position: 'top' }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Principal Component 1' } },
                            y: { title: { display: true, text: 'Principal Component 2' } }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>